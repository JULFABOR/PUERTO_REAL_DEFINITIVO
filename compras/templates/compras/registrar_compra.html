<!-- templates/compras/registrar_compra.html -->
{% extends "home/base.html" %}
{% block content %}

<div class="max-w-4xl mx-auto p-6 bg-white rounded-lg shadow-md">
  <h2 class="text-2xl font-bold mb-4 text-gray-700">Registrar compra</h2>

  <form method="post">
    {% csrf_token %}

    <!-- Proveedor -->
    <div class="mb-4">
      <label for="proveedor_id" class="block mb-2 text-sm font-medium text-gray-700">Proveedor</label>
      <select id="proveedor_id" name="proveedor_id" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-purple-500 focus:border-purple-500 block w-full p-2.5" required>
        {% for proveedor in proveedores %}
          <option value="{{ proveedor.id_proveedor }}">{{ proveedor.nombre_proveedor }}</option>
        {% endfor %}
      </select>
    </div>

    <!-- Productos -->
    <div>
      <h3 class="text-lg font-semibold mb-2 text-gray-600">Productos</h3>
      <table id="tabla-productos" class="w-full text-sm text-left text-gray-600 mb-4">
        <thead class="text-xs text-gray-700 uppercase bg-gray-100">
          <tr>
            <th class="px-3 py-2">Producto</th>
            <th class="px-3 py-2">Cantidad</th>
            <th class="px-3 py-2">Precio unitario</th>
            <th class="px-3 py-2 text-center">Eliminar</th>
          </tr>
        </thead>
        <tbody>
          <tr class="producto-row bg-white border-b">
            <td class="px-3 py-2">
              <select name="producto_id[]" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg p-2 w-full" required>
                {% for producto in productos %}
                  <option value="{{ producto.id_producto }}">{{ producto.nombre_producto }}</option>
                {% endfor %}
              </select>
            </td>
            <td class="px-3 py-2">
              <input type="number" name="cantidad[]" min="1" class="bg-gray-50 border border-gray-300 text-sm rounded-lg p-2 w-full" required>
            </td>
            <td class="px-3 py-2">
              <input type="number" name="precio_unitario[]" min="0" step="0.01" class="bg-gray-50 border border-gray-300 text-sm rounded-lg p-2 w-full" required>
            </td>
            <td class="px-3 py-2 text-center">
              <button type="button" onclick="eliminarFila(this)" class="text-red-600 hover:text-red-800">❌</button>
            </td>
          </tr>
        </tbody>
      </table>

      <div class="flex justify-between items-center mb-4">
        <button type="button" onclick="agregarFila()" class="text-purple-600 hover:underline font-medium text-sm">➕ Agregar producto</button>
      </div>
    </div>

    <!-- Botón de envío -->
    <div class="mt-6">
      <button type="submit" class="text-white bg-purple-600 hover:bg-purple-700 focus:ring-4 focus:outline-none focus:ring-purple-300 font-medium rounded-lg text-sm px-5 py-2.5 text-center">
        Registrar compra
      </button>
    </div>
  </form>
</div>

<!-- Scripts -->
<script>
function agregarFila() {
  const fila = document.querySelector('.producto-row');
  const nueva = fila.cloneNode(true);
  nueva.querySelectorAll('input').forEach(input => input.value = '');
  document.querySelector('#tabla-productos tbody').appendChild(nueva);
}

function eliminarFila(btn) {
  const row = btn.closest('tr');
  const totalFilas = document.querySelectorAll('.producto-row').length;
  if (totalFilas > 1) {
    row.remove();
  }
}
</script>

{% endblock %}